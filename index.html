<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Buddycloud photo wall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
  <link href="css/main.css" rel="stylesheet"> 
  </head>

  <body>

    <div class="container-narrow">
      <div class="jumbotron">
        <h1>buddycloud photo wall</h1>
    <div id="dropzone-upload">
      <div id="message">
        <h2>Drop files here or click to upload</h2>
      </div>
    </div>
    <hr>
      </div>

    <div id="container"/>
    
    </div>

    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
      <script src="js/dropzone.js"></script>
    <script src="js/dropzone-patch.js"></script>
    <script src="js/jquery.masonry.min.js"></script>
    <script src="js/buddycloud.js"></script>
    
    <script>

      var jid = 'photo-demo@buddycloud.org';
      var password = 'photo-demo';
      var apiUrl = 'https://api.buddycloud.org/';
      var photosUrl = apiUrl + jid + '/content/photos';
      
      function authHeader() {
        return 'Basic ' + btoa(jid + ':' + password);
      }
      
      // Create application node if it does not exist
      function createApplicationNode() {
        return buddycloud.Node.create(jid, 'photos');
      }
      
      function retrievePhotosNodeContent() {
        return buddycloud.Content.get({'channel': jid, 'node': 'photos'});
      }

      function loadImages(data) {
        for(var i in data) {
          var jsonEntry = JSON.parse(data[i].content);
          var mediaId = jsonEntry.id;
          var mediaEntity = jsonEntry.entityId;
          if (!mediaId || !mediaEntity) {
            continue;
          }
          var imgUrl = apiUrl + mediaEntity + '/media/' + mediaId;
          var box = $('<img class="box" src="' + imgUrl + '"/>');
          var imgEl = $('#container').prepend(box).masonry('reload');
          //$('#container').masonry('appended', box);
        }
      }
      
      function postToPhotoNode(content) {
        buddycloud.Content.add(
          {'channel': jid, 'node': 'photos', 'content': content}).done(retrievePhotosNodeContent);
      }

      function initializeDropzone() {
        var mediaUrl = apiUrl + jid + '/media'
        var myDropzone = new Dropzone('#dropzone-upload', {
          url: mediaUrl,
          paramName: 'data',
          sending: function(file, xhr, formData){
            xhr.setRequestHeader('Authorization', authHeader());
          },
          success: function(file, response) {
            postToPhotoNode(response);
          }
        });
      }
      
      function initializeMasonry() {
        $('#container').masonry({
          itemSelector: '.box',
          columnWidth: 300
        });
      }

      function initializeBuddycloud() {
        return buddycloud.Auth.login(jid, password);
      }
      
      $(document).ready(function() {
        initializeMasonry();
        initializeBuddycloud().done(function() {
          retrievePhotosNodeContent().always(function() {
            initializeDropzone();
            $('#container').empty(); 
          }).done(loadImages).error(function(e) {
            createApplicationNode();
          });
        });
      });
      
    </script>
  </body>
</html>
