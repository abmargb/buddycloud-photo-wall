<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Buddycloud photo wall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
	<link href="css/main.css" rel="stylesheet">	
  </head>

  <body>

    <div class="container-narrow">
      <div class="jumbotron">
        <h1>buddycloud photo wall</h1>
		<div id="dropzone-upload">
			<div id="message">
				<h2>Drop files here or click to upload</h2>
			</div>
		</div>
		<hr>
      </div>

	  <div id="container"/>
	  
    </div>
	
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/dropzone.js"></script>
	<script src="js/dropzone-patch.js"></script>
	<script src="js/jquery.masonry.min.js"></script>
	
	<script>

		var jid = 'abmargb-tester@buddycloud.org';
		var password = 'abmar123';
		var apiUrl = 'https://api.buddycloud.org/';
		var photosUrl = apiUrl + jid + '/content/photos';
		
		function authHeader() {
			return 'Basic ' + btoa(jid + ':' + password);
		}
		
		function displayPhotoStream() {
			$('#container').empty();
			$.ajax({
				type: 'GET',
				url:  photosUrl,
				success: function(data) {
					for(var i in data) {
						var jsonEntry = JSON.parse(data[i].content);
						var mediaId = jsonEntry.id;
						var mediaEntity = jsonEntry.entityId;
						if (!mediaId || !mediaEntity) {
							continue;
						}
						var imgUrl = apiUrl + mediaEntity + '/media/' + mediaId;
						var box = $('<img class="box" src="' + imgUrl + '"/>');
						var imgEl = $('#container').append(box);
						$('#container').masonry('appended', box);
					}
					
				},
				contentType: 'application/json',
				headers: {
					'Authorization': authHeader(), 
					'Accept' : 'application/json'
				}
			});
		}
		
		$(document).ready(function() {
		
			$('#container').masonry({
				itemSelector: '.box',
				columnWidth: 300
			});
			
			displayPhotoStream();
			var mediaUrl = apiUrl + jid + '/media'
			
			var myDropzone = new Dropzone('#dropzone-upload', {
				url: mediaUrl,
				paramName: 'data',
				
				sending: function(file, xhr, formData){
					xhr.setRequestHeader('Authorization', authHeader());
					console.log(xhr.headers);
				},
				
				success: function(file, response) {
					$.ajax({
						type: 'POST',
						url:  photosUrl,
						data: JSON.stringify({ content: JSON.stringify(response) }),
						success: function() {
							displayPhotoStream();
						},
						dataType: 'json',
						contentType: 'application/json',
						headers: {'Authorization': authHeader()}
					});
				}
			});
		});
	</script>
  </body>
</html>
